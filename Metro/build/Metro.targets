<Project>

    <PropertyGroup>
        <MetroNugetDirectory>$(MSBuildThisFileDirectory)..</MetroNugetDirectory>
        <MetroGeneratorAssembly>$(MetroNugetDirectory)\lib\net9.0\MetroGenerator.dll</MetroGeneratorAssembly>
        <OpenApiOutputFile>$(MSBuildProjectDirectory)\generated\swagger.json</OpenApiOutputFile>
        <TypeScriptClientOutputDirectory>$(FrontendSourcePath)\generated</TypeScriptClientOutputDirectory>
    </PropertyGroup>

    <UsingTask
            TaskName="MetroGenerator.CopyFilesToClient"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <UsingTask
            TaskName="MetroGenerator.CreateGeneratedFolder"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <UsingTask
            TaskName="MetroGenerator.TypeScriptClientGenerator"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <UsingTask
            TaskName="MetroGenerator.OpenApiDocumentGenerator"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <Target Name="validateFrontendSourcePath" AfterTargets="Build">
        <Error Condition="'$(FrontendSourcePath)' == ''"
               Text="Metro: Error - FrontendSourcePath is not set. Please define the FrontendSourcePath property in your project file." />
    </Target>

    <Target Name="generateOpenApi" Condition="'$(FrontendSourcePath)' != ''" AfterTargets="validateFrontendSourcePath">
        <Message Text="Metro: Generating OpenApi document..." Importance="high" />
        <OpenApiDocumentGenerator
                BuildPath="$(MSBuildProjectDirectory)"
                AssemblyPath="$(TargetPath)"
                NugetPath="$(MetroNugetDirectory)"
        />
    </Target>

    <Target Name="copyRunTimeConfig" Condition="'$(FrontendSourcePath)' != ''" AfterTargets="generateOpenApi">
        <Message Text="Metro: Copying files to client..." Importance="high" />
        <CopyFilesToClient
                TypeScriptClientOutputDirectory="$(TypeScriptClientOutputDirectory)"
                NugetPath="$(MetroNugetDirectory)"
        />
    </Target>

    <Target Name="generateTypeScriptClient" Condition="'$(FrontendSourcePath)' != ''" AfterTargets="copyRunTimeConfig">
        <Message Text="Metro: Generating TypeScript client..." Importance="high" />
        <TypeScriptClientGenerator
                TypeScriptClientOutputDirectory="$(TypeScriptClientOutputDirectory)"
                OpenApiFilePath="$(OpenApiOutputFile)"
                NugetPath="$(MetroNugetDirectory)"
        />
    </Target>

    <Target Name="forceOpenApiReGenerationOnRebuild" Condition="'$(FrontendSourcePath)' != ''" AfterTargets="CoreClean">
        <Message Text="Metro: Cleaning previously generated OpenApi document..." Importance="high" />
        <Delete Files="$(OpenApiOutputFile)"></Delete>
    </Target>

    <Target Name="forceFolderReGenerationOnRebuild" Condition="'$(FrontendSourcePath)' != ''" AfterTargets="CoreClean">
        <Message Text="Metro: Cleaning previously generated folder..." Importance="high" />
        <Delete Files="$(TypeScriptClientOutputDirectory)\*"></Delete>
    </Target>

</Project>