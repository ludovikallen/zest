<Project>

    <PropertyGroup>
        <MetroAssemblyDir Condition="'$(MetroAssemblyDir)' == ''">$(MSBuildThisFileDirectory)..\lib\net9.0</MetroAssemblyDir>
        <MetroGeneratorAssembly>$(MetroAssemblyDir)\MetroGenerator.dll</MetroGeneratorAssembly>
        <OpenApiOutputDir Condition="'$(OpenApiOutputDir)' == ''">$(MSBuildProjectDirectory)\generated</OpenApiOutputDir>
        <OpenApiOutputFile Condition="'$(OpenApiOutputFile)' == ''">$(OpenApiOutputDir)\swagger.json</OpenApiOutputFile>
        <TypeScriptClientOutputDir Condition="'$(TypeScriptClientOutputDir)' == ''">$(MSBuildProjectDirectory)\frontend\src\generated</TypeScriptClientOutputDir>
        <TypeScriptClientOutputFile Condition="'$(TypeScriptClientOutputFile)' == ''">$(TypeScriptClientOutputDir)\generated.ts</TypeScriptClientOutputFile>
        <TypeScriptRuntimeConfigOutputFile Condition="'$(TypeScriptClientOutputFile)' == ''">$(TypeScriptClientOutputDir)\config\TypeScriptRuntimeConfigOutputFile.ts</TypeScriptRuntimeConfigOutputFile>
    </PropertyGroup>

    <UsingTask
            TaskName="MetroGenerator.CopyFilesToClient"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <UsingTask
            TaskName="MetroGenerator.CreateGeneratedFolder"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <UsingTask
            TaskName="MetroGenerator.TypeScriptClientGenerator"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <UsingTask
            TaskName="MetroGenerator.OpenApiDocumentGenerator"
            AssemblyFile="$(MetroGeneratorAssembly)" />

    <Target Name="generateOpenApi" AfterTargets="Build">
        <Message Text="Metro: Generating OpenApi document..." Importance="high" />
        <OpenApiDocumentGenerator
            BuildPath="$(MSBuildProjectDirectory)"
            AssemblyPath="$(TargetPath)">
        </OpenApiDocumentGenerator>
    </Target>

    <Target Name="forceOpenApiReGenerationOnRebuild" AfterTargets="CoreClean">
        <Message Text="Metro: Cleaning previously generated OpenApi document..." Importance="high" />
        <Delete Files="$(OpenApiOutputFile)"></Delete>
    </Target>

    <Target Name="copyRunTimeConfig" AfterTargets="generateOpenApi">
        <Message Text="Metro: Copying files to client..." Importance="high" />
        <CopyFilesToClient
                BuildPath="$(MSBuildProjectDirectory)">
        </CopyFilesToClient>
    </Target>

    <Target Name="forceFolderReGenerationOnRebuild" AfterTargets="CoreClean">
        <Message Text="Metro: Cleaning previously generated folder..." Importance="high" />
        <Delete Files="$(TypeScriptClientOutputDir)"></Delete>
    </Target>

    <Target Name="generateTypeScriptClient" AfterTargets="copyRunTimeConfig">
        <Message Text="Metro: Generating TypeScript client..." Importance="high" />
        <TypeScriptClientGenerator BuildPath="$(MSBuildProjectDirectory)"></TypeScriptClientGenerator>
    </Target>

</Project>